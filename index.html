<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø±ØµØ¯ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªØ¯Ø±ÙŠØ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .form-input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s;
            color: #1f2937;
            font-weight: 500;
        }
        .form-input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #006b5a;
            box-shadow: 0 0 0 1px #006b5a;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
            color: #374151;
        }
        .image-upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            cursor: pointer;
            text-align: center;
            color: #6b7280;
            height: 150px;
        }
        .image-upload-box:hover {
            border-color: #006b5a;
            background-color: #f9fafb;
        }
        .image-upload-box img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-3xl mx-auto my-8 p-4">
        <div id="auth-status" class="p-2 mb-4 text-center text-white font-bold bg-yellow-500 rounded-md">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        
        <div id="report-form" class="bg-white p-6 rounded-lg shadow-lg">
            <header class="bg-[#006b5a] text-white p-4 -m-6 mb-6 rounded-t-lg">
                 <h1 class="text-xl font-bold text-center">Ù†Ù…ÙˆØ°Ø¬ Ø±ØµØ¯ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³</h1>
            </header>
            
            <main class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="teacherName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ù†ÙØ°:</label>
                        <input type="text" id="teacherName" class="form-input">
                    </div>
                    <div>
                        <label for="principalName" class="form-label">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</label>
                        <input type="text" id="principalName" class="form-input" value="Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="strategyName" class="form-label">Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</label>
                        <input type="text" id="strategyName" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª">
                    </div>
                    <div>
                        <label for="subject" class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                        <input type="text" id="subject" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">
                    </div>
                    <div>
                        <label for="executionDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°:</label>
                        <input type="text" id="executionDate" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 1447/12/12Ù‡Ù€">
                    </div>
                </div>
                
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="stage" class="form-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
                        <input type="text" id="stage" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·">
                    </div>
                    <div>
                        <label for="classSection" class="form-label">Ø§Ù„ÙØµÙ„:</label>
                        <input type="text" id="classSection" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£ + Ø¨">
                    </div>
                    <div>
                        <label for="studentCount" class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</label>
                        <input type="number" id="studentCount" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 30">
                    </div>
                </div>
                
                <div>
                    <label for="lesson" class="form-label">Ø§Ù„Ø¯Ø±Ø³:</label>
                    <input type="text" id="lesson" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©">
                </div>
                
                <div>
                    <label class="form-label">Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©: (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 border rounded-md">
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø³Ø¨ÙˆØ±Ø© ØªÙ‚Ù„ÙŠØ¯ÙŠØ©" class="ml-2">Ø³Ø¨ÙˆØ±Ø© ØªÙ‚Ù„ÙŠØ¯ÙŠØ©</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø³Ø¨ÙˆØ±Ø© Ø°ÙƒÙŠØ©" class="ml-2">Ø³Ø¨ÙˆØ±Ø© Ø°ÙƒÙŠØ©</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø¬Ù‡Ø§Ø² Ø¹Ø±Ø¶" class="ml-2">Ø¬Ù‡Ø§Ø² Ø¹Ø±Ø¶</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ø³Ø¨" class="ml-2">Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ø³Ø¨</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©" class="ml-2">Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„" class="ml-2">Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="ØµÙˆØ± ØªÙˆØ¶ÙŠØ­ÙŠØ©" class="ml-2">ØµÙˆØ± ØªÙˆØ¶ÙŠØ­ÙŠØ©</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø£Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©" class="ml-2">Ø£Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ" class="ml-2">Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ</label>
                        <label class="flex items-center"><input type="checkbox" name="teachingAids" value="ÙƒØªØ§Ø¨" class="ml-2">ÙƒØªØ§Ø¨</label>
                        
                        <label class="flex items-center md:col-span-3">
                            <input type="checkbox" name="teachingAids" value="Ø£Ø®Ø±Ù‰" class="ml-2">Ø£Ø®Ø±Ù‰:
                            <input type="text" id="teachingAidsOther" class="form-input ml-2 flex-1" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø¯Ø§Ø© Ø£Ø®Ø±Ù‰...">
                        </label>
                    </div>
                </div>
                
                <div>
                    <label for="objectives" class="form-label">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù: (Ø§ÙƒØªØ¨ ÙƒÙ„ Ù‡Ø¯Ù ÙÙŠ Ø³Ø·Ø±)</label>
                    <textarea id="objectives" rows="4" class="form-input" placeholder="1. Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£ÙˆÙ„&#10;2. Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø«Ø§Ù†ÙŠ&#10;3. Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø«Ø§Ù„Ø«"></textarea>
                </div>

                <div>
                    <label class="form-label">Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°: (ØµÙˆØ±ØªØ§Ù†)</label>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="image-upload-box-1" class="image-upload-box">
                            <img id="image-preview-1" class="hidden" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù¡">
                            <span id="image-placeholder-1">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</span>
                            <input type="file" id="image-input-1" class="hidden" accept="image/*">
                        </div>
                         <div id="image-upload-box-2" class="image-upload-box">
                            <img id="image-preview-2" class="hidden" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù¢">
                            <span id="image-placeholder-2">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</span>
                            <input type="file" id="image-input-2" class="hidden" accept="image/*">
                        </div>
                    </div>
                </div>
            </main>
            
            <footer class="mt-6 pt-6 border-t">
                <div id="action-buttons" class="flex flex-col sm:flex-row justify-center items-center gap-4">
                     <button id="saveButton" disabled class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...
                    </button>
                </div>
                <div id="success-message" class="hidden mt-4 text-center text-white bg-green-600 p-3 rounded-lg">
                    ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!
                </div>
            </footer>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBMDIL5dPISS4pRimDfN_22NMd1l0QNsCA",
          authDomain: "reports-e0260.firebaseapp.com",
          projectId: "reports-e0260",
          storageBucket: "reports-e0260.firebasestorage.app",
          messagingSenderId: "879236632191",
          appId: "1:879236632191:web:da49b42e6af93ea1d6794a"
        };
        
        let app, db, auth;
        const appId = firebaseConfig.projectId;
        const authStatus = document.getElementById('auth-status');
        const saveButton = document.getElementById('saveButton');
        let editMode = false;
        let editDocId = null;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authStatus.textContent = 'ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase';
            authStatus.className = 'p-2 mb-4 text-center text-white font-bold bg-red-700 rounded-md';
            saveButton.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©';
        }

        signInAnonymously(auth).catch(err => {
            console.error("Anonymous sign-in failed:", err);
            authStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„! ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø³ØªØ¶Ø§Ù (https) ÙˆÙ„ÙŠØ³ ÙƒÙ…Ù„Ù.';
            authStatus.className = 'p-2 mb-4 text-center text-white font-bold bg-red-700 rounded-md';
            saveButton.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©';
            saveButton.disabled = true;
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authStatus.textContent = 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­';
                authStatus.className = 'p-2 mb-4 text-center text-white font-bold bg-green-600 rounded-md';
                saveButton.disabled = false;
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('edit')) {
                    editDocId = urlParams.get('edit');
                    editMode = true;
                    saveButton.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                    document.title = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                    loadReportForEditing(editDocId);
                } else {
                     saveButton.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                }
            } 
        });

        function setupImageUpload(boxId, inputId, previewId, placeholderId) {
            const box = document.getElementById(boxId);
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);

            box.addEventListener('click', () => input.click());
            input.addEventListener('change', () => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        setupImageUpload('image-upload-box-1', 'image-input-1', 'image-preview-1', 'image-placeholder-1');
        setupImageUpload('image-upload-box-2', 'image-input-2', 'image-preview-2', 'image-placeholder-2');
        
        async function loadReportForEditing(docId) {
            try {
                const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
                const docSnap = await getDoc(reportRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('teacherName').value = data.teacherName || '';
                    document.getElementById('principalName').value = data.principalName || 'Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ';
                    document.getElementById('strategyName').value = data.strategyName || '';
                    document.getElementById('subject').value = data.subject || '';
                    document.getElementById('executionDate').value = data.executionDate || '';
                    document.getElementById('stage').value = data.stage || '';
                    document.getElementById('classSection').value = data.classSection || '';
                    document.getElementById('studentCount').value = data.studentCount || '';
                    document.getElementById('lesson').value = data.lesson || '';
                    document.getElementById('objectives').value = data.objectives || '';
                    
                    // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª "Ø£Ø®Ø±Ù‰"
                    document.getElementById('teachingAidsOther').value = data.teachingAidsOther || '';
                    
                    if (data.teachingAids) {
                        data.teachingAids.forEach(aidValue => {
                            const checkbox = document.querySelector(`input[name="teachingAids"][value="${aidValue}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                     if (data.image1) {
                        document.getElementById('image-preview-1').src = data.image1;
                        document.getElementById('image-preview-1').classList.remove('hidden');
                        document.getElementById('image-placeholder-1').classList.add('hidden');
                    }
                     if (data.image2) {
                        document.getElementById('image-preview-2').src = data.image2;
                        document.getElementById('image-preview-2').classList.remove('hidden');
                        document.getElementById('image-placeholder-2').classList.add('hidden');
                    }
                    
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.');
                }
            } catch(error) {
                console.error("Error loading report for edit:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
            }
        }

        saveButton.addEventListener('click', async () => {
            saveButton.disabled = true;
            saveButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            const getBase64FromInput = async (inputId) => {
                const input = document.getElementById(inputId);
                if (input.files && input.files[0]) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (error) => {
                            console.error('FileReader error:', error);
                            reject(new Error('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.toString()));
                        };
                        try {
                            reader.readAsDataURL(input.files[0]);
                        } catch (e) {
                            console.error('readAsDataURL error:', e);
                            reject(e);
                        }
                    });
                }
                if(editMode) {
                    const preview = document.getElementById(inputId.replace('input', 'preview'));
                    if(preview && preview.src && !preview.src.startsWith('blob:')) {
                        return preview.src;
                    }
                }
                return null;
            };
            
            const selectedAids = Array.from(document.querySelectorAll('input[name="teachingAids"]:checked')).map(cb => cb.value);

            try {
                const reportData = {
                    teacherName: document.getElementById('teacherName').value,
                    principalName: document.getElementById('principalName').value,
                    strategyName: document.getElementById('strategyName').value,
                    subject: document.getElementById('subject').value,
                    executionDate: document.getElementById('executionDate').value,
                    stage: document.getElementById('stage').value,
                    classSection: document.getElementById('classSection').value,
                    studentCount: document.getElementById('studentCount').value,
                    lesson: document.getElementById('lesson').value,
                    teachingAids: selectedAids,
                    // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª "Ø£Ø®Ø±Ù‰"
                    teachingAidsOther: document.getElementById('teachingAidsOther').value,
                    objectives: document.getElementById('objectives').value,
                    image1: await getBase64FromInput('image-input-1'),
                    image2: await getBase64FromInput('image-input-2'),
                };

                if (editMode && editDocId) {
                     reportData.updatedAt = serverTimestamp();
                     const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, editDocId);
                     await updateDoc(reportRef, reportData);
                     alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
                     window.close();
                } else {
                    reportData.createdAt = serverTimestamp();
                    const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/strategies`), reportData);
                    document.getElementById('success-message').classList.remove('hidden');
                    saveButton.style.display = 'none';
                }
            } catch (error) {
                console.error("Error saving document: ", error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
                saveButton.disabled = false;
                saveButton.textContent = editMode ? 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
            }
        });
    </script>

</body>
</html>
