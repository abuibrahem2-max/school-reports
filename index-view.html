<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض تقارير استراتيجيات التدريس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f9fafb;
        }
        .page-container {
            max-width: 1000px;
            margin: 2rem auto;
            background-color: white;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        
        /* --- أنماط التصميم الجديد (من ملف النشاط) --- */
        .form-title {
            background-color: #006b5a;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr 2fr);
        }
        .form-label-cell,
        .form-data-cell {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            min-height: 50px;
            word-break: break-word;
        }
        .form-label-cell {
            background-color: #f3f4f6;
            font-weight: 500;
            color: #1f2937;
        }
        .label-span-1 { grid-column: span 1; }
        .data-span-3 { grid-column: span 3; }
        /* --- نهاية الأنماط الجديدة --- */
        
        .printable-offscreen {
            position: absolute;
            left: -9999px;
            width: 842px; /* A4 portrait width in pixels */
        }

        .evidence-image-container {
            width: 100%;
            height: 250px;
            overflow: hidden;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
        }
        .evidence-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        @media print {
            body.printing > :not(#report-display-wrapper),
            body.printing .no-print {
                display: none !important;
            }
            @page { size: A4; margin: 0; }
            
            body.printing {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-color: white;
                margin: 0;
                padding: 0;
            }

            body.printing #report-display-wrapper { margin: 0; padding: 0; }
            body.printing #report-display {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                max-width: 100% !important;
                border-radius: 0;
                font-size: 9pt;
            }
             body.printing .form-label-cell, body.printing .form-data-cell {
                padding: 0.3rem 0.5rem;
                min-height: 40px;
            }
            body.printing header, body.printing footer { padding: 0.5rem; }
            body.printing h1.form-title { padding: 0.5rem; margin: 0.5rem 1rem; }
             /* ضمان طباعة ألوان الخلفية */
            body.printing .print-bg-green {
                background-color: #006b5a !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="page-container no-print">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">تقارير استراتيجيات التدريس</h2>
                <button onclick="printReportsList()" id="print-list-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    طباعة القائمة
                </button>
            </div>
             <div id="reports-list" class="space-y-1">
                <p class="text-gray-500 text-center p-4">جاري تحميل التقارير...</p>
            </div>
        </div>
    </div>
    
    <div id="report-display-wrapper">
         <div id="report-display" class="hidden page-container">
            </div>
    </div>
    
    <div id="report-actions" class="hidden max-w-4xl mx-auto p-4 text-center no-print bg-white flex justify-center items-center gap-4" style="margin-top: -2rem; position: relative; z-index: 10; border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);">
        <button onclick="downloadPdf()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">تحميل PDF</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { jsPDF } = window.jspdf;

        // *** ضع نفس إعدادات Firebase الخاصة بك هنا ***
        const firebaseConfig = {
          apiKey: "AIzaSyBMDIL5dPISS4pRimDfN_22NMd1l0QNsCA",
          authDomain: "reports-e0260.firebaseapp.com",
          projectId: "reports-e0260",
          storageBucket: "reports-e0260.firebasestorage.app",
          messagingSenderId: "879236632191",
          appId: "1:879236632191:web:da49b42e6af93ea1d6794a"
        };

        const appId = firebaseConfig.projectId;
        
        let app, db, auth;
        let currentReportData = null;
        let allReportsData = [];
       
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                listenForReports();
            } else {
                 signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in failed:", err);
                 });
            }
        });

        const reportsList = document.getElementById('reports-list');
        const reportDisplay = document.getElementById('report-display');
        const reportActions = document.getElementById('report-actions');
        
        function listenForReports() {
            const reportsRef = collection(db, `/artifacts/${appId}/public/data/strategies`);
            const q = query(reportsRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (querySnapshot) => {
                allReportsData = []; 
                if (querySnapshot.empty) {
                    reportsList.innerHTML = '<p class="text-gray-500 text-center p-4">لا توجد تقارير استراتيجيات محفوظة حتى الآن.</p>';
                    return;
                }

                reportsList.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 font-bold text-sm text-gray-600 px-3 py-2 border-b">
                        <div class="col-span-3">اسم المعلم</div>
                        <div class="col-span-3">الاستراتيجية</div>
                        <div class="col-span-2">المادة</div>
                        <div class="col-span-2">تاريخ التنفيذ</div>
                        <div class="col-span-2 text-center">إجراءات</div>
                    </div>
                `; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allReportsData.push(data); 
                    const docId = doc.id;
                    
                    const teacherName = data.teacherName || 'معلم غير مسجل';
                    const strategyName = data.strategyName || 'استراتيجية غير مسجلة';
                    const subject = data.subject || 'N/A';
                    const executionDate = data.executionDate || 'N/A';

                    const listItem = document.createElement('div');
                    listItem.className = 'grid grid-cols-12 gap-2 items-center text-sm p-3 border-b hover:bg-gray-100 cursor-pointer';
                    
                    listItem.innerHTML = `
                        <div class="col-span-3 font-semibold text-blue-700 truncate" onclick="window.displayReportById('${docId}')">${teacherName}</div>
                        <div class="col-span-3 text-gray-700 truncate" onclick="window.displayReportById('${docId}')">${strategyName}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${subject}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${executionDate}</div>
                        <div class="col-span-2 text-center flex justify-center gap-3">
                             <a href="./form-strategiat.html?edit=${docId}" target="_blank" class="text-blue-600 hover:text-blue-800" title="تعديل التقرير">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </a>
                            <button onclick="window.deleteReport(event, '${docId}')" class="text-red-600 hover:text-red-800" title="حذف التقرير">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `;
                    reportsList.appendChild(listItem);
                });

            }, (error) => {
                console.error("Error fetching reports in real-time:", error);
                reportsList.innerHTML = '<p class="text-red-500 text-center p-4">حدث خطأ في تحميل قائمة التقارير.</p>';
            });
        }
        
        window.printReportsList = async function() {
            const btn = document.getElementById('print-list-btn');
            btn.disabled = true;
            btn.innerHTML = '<span>جاري التجهيز...</span>';

            const printableList = document.createElement('div');
            printableList.className = 'printable-offscreen';
            
            const tableRows = allReportsData.map((data, index) => {
                const teacherName = data.teacherName || 'غير محدد';
                const strategyName = data.strategyName || 'برنامج بدون اسم';
                const subject = data.subject || '';
                const executionDate = data.executionDate || '';
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 8px; border: 1px solid #9ca3af; text-align: center;">${index + 1}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${teacherName}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${strategyName}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${subject}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${executionDate}</td>
                    </tr>
                `;
            }).join('');

            printableList.innerHTML = `
                <div dir="rtl" style="padding: 2rem; font-family: 'Tajawal', sans-serif; background-color: white; color: black; display: flex; flex-direction: column; justify-content: space-between; min-height: 1050px;">
                    <div>
                        <div style="text-align: center; font-weight: 700; margin-bottom: 2rem;">
                            <p style="font-size: 1.25rem; margin: 0;">المملكة العربية السعودية</p>
                            <p style="font-size: 1.125rem; margin: 0;">وزارة التعليم</p>
                            <p style="font-size: 1.125rem; margin: 0;">الإدارة العامة للتعليم بمنطقة عسير</p>
                            <p style="font-size: 1.125rem; margin: 0;">ابتدائية ومتوسطة الراشدون بالمربع</p>
                        </div>
                        <table style="width: 100%; font-size: 10pt; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #06b6d4; color: white; font-weight: 700;">
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">م</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">اسم المعلم</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">الاستراتيجية</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">المادة</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">تاريخ التنفيذ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 4rem; font-weight: 700; font-size: 1.125rem;">
                        <div>
                            <p>المشرف/ المنسق:</p>
                            <p>علي إبراهيم عسيري</p>
                        </div>
                        <div>
                            <p>مدير المدرسة:</p>
                            <p>أحمد سالم الشهري</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(printableList);

            try {
                const canvas = await html2canvas(printableList, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                pdf.save('قائمة-تقارير-الاستراتيجيات.pdf');
            } catch (error) {
                console.error("Error generating list PDF:", error);
                alert("حدث خطأ أثناء إنشاء ملف قائمة التقارير.");
            } finally {
                document.body.removeChild(printableList);
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg> <span>طباعة القائمة</span>`;
            }
        }
        
        window.deleteReport = async function(event, docId) {
            event.stopPropagation();
            if (confirm('هل أنت متأكد من حذف هذا التقرير؟ لا يمكن التراجع عن هذا الإجراء.')) {
                try {
                    const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
                    await deleteDoc(reportRef);
                    alert('تم حذف التقرير بنجاح.');
                    if (currentReportData && currentReportData.id === docId) {
                       reportDisplay.classList.add('hidden');
                       reportActions.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert(`حدث خطأ أثناء حذف التقرير: ${error.message}`);
                }
            }
        }
        
        window.downloadPdf = async function() {
            const reportContent = document.querySelector("#report-display .printable-content");
            if (!reportContent || !currentReportData) {
                alert("يرجى عرض تقرير أولاً.");
                return;
            }
            const programName = currentReportData.strategyName || 'استراتيجية';
            const teacherName = currentReportData.teacherName || 'معلم';
            const filename = `${programName} - ${teacherName}.pdf`;


            const canvas = await html2canvas(reportContent, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
            pdf.save(filename);
        }

        window.displayReportById = async (docId) => {
            const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
            try {
                const docSnap = await getDoc(reportRef);
                if (docSnap.exists()){
                    const data = docSnap.data();
                    data.id = docId; 
                    currentReportData = data;
                    displayReportData(data); // استدعاء الدالة الجديدة
                } else {
                    alert("لم يتم العثور على التقرير.");
                    currentReportData = null;
                }
            } catch(error) {
                 alert("خطأ في جلب بيانات التقرير.");
                 console.error(error);
                 currentReportData = null;
            }
        };

        //
        // --- *** دالة عرض التقرير الجديدة (بالتصميم المدمج) *** ---
        //
        function displayReportData(data) {
            
            // إعادة تنسيق القوائم لتناسب الجدول
            const aidsList = data.teachingAids && data.teachingAids.length > 0
                ? `<ul class="text-blue-800 font-semibold grid grid-cols-2 gap-1 w-full">${data.teachingAids.map(aid => `<li class="list-disc mr-4">${aid}</li>`).join('')}</ul>`
                : '<span class="text-blue-800 font-semibold">لا يوجد</span>';

            const objectivesList = data.objectives
                ? `<ol class="text-blue-800 font-semibold list-decimal pr-5">${data.objectives.split('\n').filter(line => line.trim() !== '').map(obj => `<li class="mb-1">${obj}</li>`).join('')}</ol>`
                : '<span class="text-blue-800 font-semibold">لا يوجد</span>';

            // هذا هو التصميم الجديد المدمج
            reportDisplay.innerHTML = `
                <div class="printable-content">
                    <header class="bg-[#006b5a] text-white p-4 print-bg-green">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            <div class="w-1/3 text-right text-xs leading-tight">
                                <p>الإدارة العامة للتعليم بمنطقة عسير</p>
                                <p class="font-bold text-sm text-yellow-300">ابتدائية ومتوسطة الراشدون بالمربع</p>
                            </div>
                            <div class="w-1/3 text-center">
                                <img src="https://upload.wikimedia.org/wikipedia/ar/2/20/MOELogo.svg" alt="شعار الوزارة" class="h-16 mx-auto">
                            </div>
                            <div class="w-1/3 text-left">
                                <img src="https://upload.wikimedia.org/wikipedia/ar/f/f5/Saudi_Vision_2030_logo.svg" alt="شعار الرؤية" class="h-16 mx-auto">
                            </div>
                        </div>
                    </header>
                    
                    <h1 class="form-title mt-4 mb-4 mx-4">تقرير رصد استراتيجية تدريس حديثة</h1>
                    
                    <main class="px-4">
                        <div class="form-grid">
                            <div class="form-label-cell">اسم المعلم المنفذ:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.teacherName || ''}</span></div>
                            <div class="form-label-cell">مدير المدرسة:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.principalName || ''}</span></div>

                            <div class="form-label-cell">الاستراتيجية:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.strategyName || ''}</span></div>
                            <div class="form-label-cell">المادة:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.subject || ''}</span></div>

                            <div class="form-label-cell">تاريخ التنفيذ:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.executionDate || ''}</span></div>
                            <div class="form-label-cell">الدرس:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.lesson || ''}</span></div>

                            <div class="form-label-cell">المرحلة الدراسية:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.stage || ''}</span></div>
                            <div class="form-label-cell">الفصل:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.classSection || ''}</span></div>
                            
                            <div class="form-label-cell">عدد الطلاب:</div>
                            <div class="form-data-cell data-span-3"><span class="text-blue-800 font-semibold">${data.studentCount || ''}</span></div>

                            <div class="form-label-cell label-span-1">الأدوات والوسائل التعليمية:</div>
                            <div class="form-data-cell data-span-3">${aidsList}</div>
                            
                            <div class="form-label-cell label-span-1">الأهداف:</div>
                            <div class="form-data-cell data-span-3">${objectivesList}</div>

                            <div class="form-label-cell label-span-1">شواهد التنفيذ:</div>
                            <div class="form-data-cell data-span-3">
                                <div class="w-full flex gap-4">
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image1 ? `<img src="${data.image1}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">لم يتم رفع صورة 1</span>'}
                                        </div>
                                    </div>
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image2 ? `<img src="${data.image2}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">لم يتم رفع صورة 2</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer class="bg-[#006b5a] p-4 mt-4 print-bg-green">
                        <div class="text-center">
                            <p class="text-white text-sm font-bold">www.moe.gov.sa</p>
                        </div>
                    </footer>
                </div>
            `;
            
            reportDisplay.classList.remove('hidden');
            reportActions.classList.remove('hidden');
            reportDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
