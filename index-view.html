<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f9fafb;
        }
        .page-container {
            max-width: 1000px;
            margin: 2rem auto;
            background-color: white;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
            /* ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø³Ù„Ø³ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ */
            transition: max-width 0.3s ease;
        }
        .form-title {
            background-color: #006b5a;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr 2fr);
        }
        .form-label-cell,
        .form-data-cell {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            min-height: 50px;
            word-break: break-word;
        }
        .form-label-cell {
            background-color: #f3f4f6;
            font-weight: 500;
            color: #1f2937;
        }
        .label-span-1 { grid-column: span 1; }
        .data-span-3 { grid-column: span 3; }
        .printable-offscreen {
            position: absolute;
            left: -9999px;
            width: 842px;
        }
        .evidence-image-container {
            width: 100%;
            height: 250px;
            overflow: hidden;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
        }
        .evidence-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        @media print {
            body.printing > :not(#report-display-wrapper),
            body.printing .no-print { display: none !important; }
            @page { size: A4; margin: 0; }
            body.printing {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-color: white;
                margin: 0; padding: 0;
            }
            body.printing #report-display-wrapper { margin: 0; padding: 0; }
            
            /* ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            body.printing #report-display.page-container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                font-size: 9pt;
            }
            body.printing .printable-content {
                padding: 1.5rem !important; /* Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§Ù…Ø´ Ù„Ù„ØµÙØ­Ø© */
            }
             body.printing .form-label-cell, body.printing .form-data-cell {
                padding: 0.3rem 0.5rem; min-height: 40px;
            }
            body.printing header, body.printing footer { padding: 0.5rem; }
            body.printing h1.form-title { padding: 0.5rem; margin: 0.5rem 0; }
            body.printing .print-bg-green { background-color: #006b5a !important; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="page-container no-print">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³</h2>
                <button onclick="printReportsList()" id="print-list-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                </button>
            </div>
             <div id="reports-list" class="space-y-1">
                <p class="text-gray-500 text-center p-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</p>
            </div>
        </div>
    </div>
    
    <div id="report-display-wrapper">
         <div id="report-display" class="hidden page-container">
            </div>
    </div>
    
    <div id="report-actions" class="hidden max-w-4xl mx-auto p-4 text-center no-print bg-white flex justify-center items-center gap-4" style="margin-top: -2rem; position: relative; z-index: 10; border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);">
        <button onclick="downloadPdf()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">ØªØ­Ù…ÙŠÙ„ PDF</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
          apiKey: "AIzaSyBMDIL5dPISS4pRimDfN_22NMd1l0QNsCA",
          authDomain: "reports-e0260.firebaseapp.com",
          projectId: "reports-e0260",
          storageBucket: "reports-e0260.firebasestorage.app",
          messagingSenderId: "879236632191",
          appId: "1:879236632191:web:da49b42e6af93ea1d6794a"
        };

        const appId = firebaseConfig.projectId;
        
        let app, db, auth;
        let currentReportData = null;
        let allReportsData = [];
       
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                listenForReports();
            } else {
                 signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in failed:", err);
                 });
            }
        });

        const reportsList = document.getElementById('reports-list');
        const reportDisplay = document.getElementById('report-display');
        const reportActions = document.getElementById('report-actions');
        
        function listenForReports() {
            const reportsRef = collection(db, `/artifacts/${appId}/public/data/strategies`);
            const q = query(reportsRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (querySnapshot) => {
                allReportsData = []; 
                if (querySnapshot.empty) {
                    reportsList.innerHTML = '<p class="text-gray-500 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
                    return;
                }

                reportsList.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 font-bold text-sm text-gray-600 px-3 py-2 border-b">
                        <div class="col-span-3">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</div>
                        <div class="col-span-3">Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</div>
                        <div class="col-span-2">Ø§Ù„Ù…Ø§Ø¯Ø©</div>
                        <div class="col-span-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                        <div class="col-span-2 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                    </div>
                `; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allReportsData.push(data); 
                    const docId = doc.id;
                    
                    const teacherName = data.teacherName || 'Ù…Ø¹Ù„Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                    const strategyName = data.strategyName || 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©';
                    const subject = data.subject || 'N/A';
                    const executionDate = data.executionDate || 'N/A';

                    const listItem = document.createElement('div');
                    listItem.className = 'grid grid-cols-12 gap-2 items-center text-sm p-3 border-b hover:bg-gray-100 cursor-pointer';
                    
                    listItem.innerHTML = `
                        <div class="col-span-3 font-semibold text-blue-700 truncate" onclick="window.displayReportById('${docId}')">${teacherName}</div>
                        <div class="col-span-3 text-gray-700 truncate" onclick="window.displayReportById('${docId}')">${strategyName}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${subject}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${executionDate}</div>
                        <div class="col-span-2 text-center flex justify-center gap-3">
                             <a href="./index.html?edit=${docId}" target="_blank" class="text-blue-600 hover:text-blue-800" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </a>
                            <button onclick="window.deleteReport(event, '${docId}')" class="text-red-600 hover:text-red-800" title="Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `;
                    reportsList.appendChild(listItem);
                });

            }, (error) => {
                console.error("Error fetching reports in real-time:", error);
                reportsList.innerHTML = '<p class="text-red-500 text-center p-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</p>';
            });
        }
        
        window.printReportsList = async function() {
            // (Code for printing list remains unchanged)
            const btn = document.getElementById('print-list-btn');
            btn.disabled = true;
            btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</span>';
            const printableList = document.createElement('div');
            printableList.className = 'printable-offscreen';
            const tableRows = allReportsData.map((data, index) => {
                const teacherName = data.teacherName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const strategyName = data.strategyName || 'Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                const subject = data.subject || '';
                const executionDate = data.executionDate || '';
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 8px; border: 1px solid #9ca3af; text-align: center;">${index + 1}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${teacherName}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${strategyName}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${subject}</td>
                        <td style="padding: 8px; border: 1px solid #9ca3af;">${executionDate}</td>
                    </tr>
                `;
            }).join('');
            printableList.innerHTML = `
                <div dir="rtl" style="padding: 2rem; font-family: 'Tajawal', sans-serif; background-color: white; color: black; display: flex; flex-direction: column; justify-content: space-between; min-height: 1050px;">
                    <div>
                        <div style="text-align: center; font-weight: 700; margin-bottom: 2rem;">
                            <p style="font-size: 1.25rem; margin: 0;">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</p>
                            <p style="font-size: 1.125rem; margin: 0;">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</p>
                            <p style="font-size: 1.125rem; margin: 0;">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ±</p>
                            <p style="font-size: 1.125rem; margin: 0;">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ÙˆÙ…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ† Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹</p>
                        </div>
                        <table style="width: 100%; font-size: 10pt; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #06b6d4; color: white; font-weight: 700;">
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th style="padding: 8px; border: 1px solid #9ca3af;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 4rem; font-weight: 700; font-size: 1.125rem;">
                        <div>
                            <p>Ø§Ù„Ù…Ø´Ø±Ù/ Ø§Ù„Ù…Ù†Ø³Ù‚:</p>
                            <p>Ø¹Ù„ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ø³ÙŠØ±ÙŠ</p>
                        </div>
                        <div>
                            <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</p>
                            <p>Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(printableList);
            try {
                const canvas = await html2canvas(printableList, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                pdf.save('Ù‚Ø§Ø¦Ù…Ø©-ØªÙ‚Ø§Ø±ÙŠØ±-Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª.pdf');
            } catch (error) {
                console.error("Error generating list PDF:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.");
            } finally {
                document.body.removeChild(printableList);
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg> <span>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>`;
            }
        }
        
        window.deleteReport = async function(event, docId) {
            event.stopPropagation();
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                try {
                    const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
                    await deleteDoc(reportRef);
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.');
                    if (currentReportData && currentReportData.id === docId) {
                       reportDisplay.classList.add('hidden');
                       reportActions.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${error.message}`);
                }
            }
        }
        
        window.downloadPdf = async function() {
            const reportContent = document.querySelector("#report-display .printable-content");
            const reportContainer = document.getElementById('report-display'); // ğŸ”´ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
            if (!reportContent || !currentReportData) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            const programName = currentReportData.strategyName || 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©';
            const teacherName = currentReportData.teacherName || 'Ù…Ø¹Ù„Ù…';
            const filename = `${programName} - ${teacherName}.pdf`;

            // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ± Ù„ÙŠÙ…Ù„Ø£ Ø§Ù„ØµÙØ­Ø©
            const originalMaxWidth = reportContainer.style.maxWidth;
            const originalMargin = reportContainer.style.margin;
            reportContainer.style.maxWidth = 'none';
            reportContainer.style.margin = '0';

            try {
                // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© allowTaint
                const canvas = await html2canvas(reportContent, { 
                    scale: 2, 
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;
                
                const ratio = pdfWidth / imgWidth;
                const calculatedHeight = imgHeight * ratio;
                let pageHeight = pdfHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, calculatedHeight);
                let heightLeft = calculatedHeight - pageHeight;

                while (heightLeft > 0) {
                    position = position - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, calculatedHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(filename);
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø³Ø¨Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©.");
            } finally {
                // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙˆÙŠØ±
                reportContainer.style.maxWidth = originalMaxWidth;
                reportContainer.style.margin = originalMargin;
            }
        }

        window.displayReportById = async (docId) => {
            const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
            try {
                const docSnap = await getDoc(reportRef);
                if (docSnap.exists()){
                    const data = docSnap.data();
                    data.id = docId; 
                    currentReportData = data;
                    displayReportData(data);
                } else {
                    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
                    currentReportData = null;
                }
            } catch(error) {
                 alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
                 console.error(error);
                 currentReportData = null;
            }
        };

        function displayReportData(data) {
            
            // ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø±Ø¶ "Ø£Ø®Ø±Ù‰"
            let aidsItems = data.teachingAids && data.teachingAids.length > 0
                ? data.teachingAids.map(aid => {
                    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ "Ø£Ø®Ø±Ù‰" ÙƒØ¹Ù†ØµØ± Ù…Ù†ÙØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙØ§Ø±ØºØ§Ù‹
                    if (aid === "Ø£Ø®Ø±Ù‰" && (!data.teachingAidsOther || data.teachingAidsOther.trim() === "")) {
                        return null; 
                    }
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± "Ø£Ø®Ø±Ù‰" ÙˆØ§Ù„Ù†Øµ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡
                    if (aid === "Ø£Ø®Ø±Ù‰" && data.teachingAidsOther && data.teachingAidsOther.trim() !== "") {
                        return `<li class="list-disc mr-4">Ø£Ø®Ø±Ù‰: ${data.teachingAidsOther}</li>`;
                    }
                    return `<li class="list-disc mr-4">${aid}</li>`;
                }).filter(item => item !== null) // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§Ø±ØºØ©
                : [];
            
            // Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± "Ø£Ø®Ø±Ù‰"
            if (data.teachingAidsOther && data.teachingAidsOther.trim() !== "" && !data.teachingAids.includes("Ø£Ø®Ø±Ù‰")) {
                 aidsItems.push(`<li class="list-disc mr-4">Ø£Ø®Ø±Ù‰: ${data.teachingAidsOther}</li>`);
            }

            const aidsList = aidsItems.length > 0
                ? `<ul class="text-blue-800 font-semibold grid grid-cols-2 gap-1 w-full">${aidsItems.join('')}</ul>`
                : '<span class="text-blue-800 font-semibold">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

            const objectivesList = data.objectives
                ? `<ol class="text-blue-800 font-semibold list-decimal pr-5">${data.objectives.split('\n').filter(line => line.trim() !== '').map(obj => `<li class="mb-1">${obj}</li>`).join('')}</ol>`
                : '<span class="text-blue-800 font-semibold">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

            reportDisplay.innerHTML = `
                <div class="printable-content">
                    <header class="bg-[#006b5a] text-white p-4 print-bg-green">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            <div class="w-1/3 text-right text-xs leading-tight">
                                <p>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ±</p>
                                <p class="font-bold text-sm text-yellow-300">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ÙˆÙ…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø±Ø§Ø´Ø¯ÙˆÙ† Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹</p>
                            </div>
                            <div class="w-1/3 text-center">
                                <img src="https://upload.wikimedia.org/wikipedia/ar/2/20/MOELogo.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©" class="h-16 mx-auto" crossorigin="anonymous">
                            </div>
                            <div class="w-1/3 text-left">
                                <img src="https://upload.wikimedia.org/wikipedia/ar/f/f5/Saudi_Vision_2030_logo.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø¤ÙŠØ©" class="h-16 mx-auto" crossorigin="anonymous">
                            </div>
                        </div>
                    </header>
                    
                    <h1 class="form-title mt-4 mb-4 mx-4">ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ° Ø§Ø³ØªØ±Ø§ØªØ¬ÙŠØ© ØªØ¯Ø±ÙŠØ³</h1>
                    
                    <main class="px-4">
                        <div class="form-grid">
                            <div class="form-label-cell">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ù†ÙØ°:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.teacherName || ''}</span></div>
                            <div class="form-label-cell">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.principalName || ''}</span></div>

                            <div class="form-label-cell">Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.strategyName || ''}</span></div>
                            <div class="form-label-cell">Ø§Ù„Ù…Ø§Ø¯Ø©:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.subject || ''}</span></div>

                            <div class="form-label-cell">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.executionDate || ''}</span></div>
                            <div class="form-label-cell">Ø§Ù„Ø¯Ø±Ø³:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.lesson || ''}</span></div>

                            <div class="form-label-cell">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.stage || ''}</span></div>
                            <div class="form-label-cell">Ø§Ù„ÙØµÙ„:</div>
                            <div class="form-data-cell"><span class="text-blue-800 font-semibold">${data.classSection || ''}</span></div>
                            
                            <div class="form-label-cell">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</div>
                            <div class="form-data-cell data-span-3"><span class="text-blue-800 font-semibold">${data.studentCount || ''}</span></div>

                            <div class="form-label-cell label-span-1">Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©:</div>
                            <div class="form-data-cell data-span-3">${aidsList}</div>
                            
                            <div class="form-label-cell label-span-1">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:</div>
                            <div class="form-data-cell data-span-3">${objectivesList}</div>

                            <div class="form-label-cell label-span-1">Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:</div>
                            <div class="form-data-cell data-span-3">
                                <div class="w-full flex gap-4">
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image1 ? `<img src="${data.image1}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© 1</span>'}
                                        </div>
                                    </div>
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image2 ? `<img src="${data.image2}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© 2</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer class="flex justify-between items-center pt-8 mt-8 border-t">
                        <div class="text-left">
                             <p class="font-bold text-lg">${data.principalName || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±'}</p>
                            <p class="text-sm text-gray-600">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg">${data.teacherName || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…'}</p>
                            <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ù†ÙØ°</p>
                        </div>
                    </footer>
                </div>
            `;
            
            reportDisplay.classList.remove('hidden');
            reportActions.classList.remove('hidden');
            reportDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
