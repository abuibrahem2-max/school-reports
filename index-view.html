<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض تقارير استراتيجيات التدريس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Kufam:wght@400;500;700&family=Cairo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f9fafb;
        }
        .page-container {
            max-width: 1000px;
            margin: 2rem auto;
            background-color: white;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
            transition: max-width 0.3s ease;
        }
        
        .pdf-render-mode {
            max-width: none !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 17px; 
        }
        .pdf-render-mode header p { font-size: 17px !important; }
        .pdf-render-mode header .text-yellow-300 { font-size: 19px !important; }
        .form-title {
            background-color: #006b5a;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.75rem;
            font-weight: bold;
        }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr 2fr); }
        .form-label-cell,
        .form-data-cell {
            padding: 1.25rem 1rem; 
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            min-height: 60px; 
            word-break: break-word;
            font-size: 17px; 
        }
        .form-label-cell { background-color: #f3f4f6; font-weight: 700; color: #1f2937; }
        .pdf-render-mode .form-data-cell { font-size: 17px !important; }
        .label-span-1 { grid-column: span 1; }
        .data-span-3 { grid-column: span 3; }
        
        .evidence-image-container {
            width: 100%;
            height: 320px;
            overflow: hidden;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
        }
        .evidence-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .printable-content footer .footer-title { font-size: 1.1rem; }
        .printable-content footer .footer-name { font-size: 1.4rem; }

        /* === (بداية كود التصاميم الجديدة) === */
        
        /* تصميم الخلفية المتموجة */
        .printable-content.design-wave {
            /* SVG بسيط ومضمن لإنشاء تموج في الأسفل بلون أخضر فاتح جداً */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23f0fdfa' fill-opacity='0.8' d='M0,192L80,176C160,160,320,128,480,133.3C640,139,800,181,960,186.7C1120,192,1280,160,1360,144L1440,128L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: bottom;
            background-size: 100% 40%; /* تغطية 40% من أسفل الصفحة */
        }

        /* تصميم التدرج الرمادي الرسمي */
        .printable-content.design-formal {
            background-color: #f8f9fa; /* خلفية رمادية فاتحة جداً */
        }
        .printable-content.design-formal .form-label-cell {
            background-color: #e9ecef; /* لون أغمق لخلايا العناوين */
        }

        /* تصميم التدرج الأخضر الناعم */
        .printable-content.design-gradient {
             /* تدرج خطي من الأبيض إلى الأخضر الفاتح جداً */
            background: linear-gradient(to bottom, #ffffff 0%, #f0fdfa 100%);
        }
        .printable-content.design-gradient .form-label-cell {
            background-color: #e6f7f4; /* لون أخضر فاتح جداً لخلايا العناوين */
        }
        
        /* === (نهاية كود التصاميم الجديدة) === */

        @media print { /* (إعدادات الطباعة تبقى كما هي) */ }
    </style>
</head>
<body class="bg-gray-50">
    
    <div class="page-container no-print">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">تقارير استراتيجيات التدريس</h2>
            </div>

            <div class="p-4 bg-gray-100 rounded-lg mb-4 flex flex-col sm:flex-row justify-around items-center no-print">
                <div class="font-semibold text-gray-700 mb-2 sm:mb-0">لتحميل الـ PDF، يرجى إضافة شعارات **PNG بخلفية شفافة**:</div>
                <div class="flex gap-4">
                    <label for="logo-upload" class="bg-blue-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700 text-sm">إضافة شعار الوزارة (PNG)</label>
                    <input type="file" id="logo-upload" class="hidden" accept="image/png">
                    <label for="vision-upload" class="bg-blue-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700 text-sm">إضافة شعار الرؤية (PNG)</label>
                    <input type="file" id="vision-upload" class="hidden" accept="image/png">
                </div>
            </div>
            <div class="p-4 bg-gray-100 rounded-lg mb-4 flex justify-start items-center gap-4 no-print flex-wrap">
                <label for="font-select" class="font-semibold text-gray-700">اختر خط التقرير:</label>
                <select id="font-select" class="p-2 border rounded-md" style="font-family: 'Tajawal', sans-serif;">
                    <option value="'Tajawal', sans-serif" style="font-family: 'Tajawal', sans-serif;">أساسي (Tajawal)</option>
                    <option value="'Kufam', cursive" style="font-family: 'Kufam', cursive;">كوفي (Kufam)</option>
                    <option value="'Cairo', sans-serif" style="font-family: 'Cairo', sans-serif;">واضح (Cairo)</option>
                </select>
                <label for="font-size-select" class="font-semibold text-gray-700 ml-4">اختر حجم الخط:</label>
                <select id="font-size-select" class="p-2 border rounded-md">
                    <option value="17px">متوسط (افتراضي)</option>
                    <option value="16px">صغير</option>
                    <option value="19px">كبير</option>
                    <option value="21px">كبير جداً</option>
                </select>
                
                <label for="design-select" class="font-semibold text-gray-700 ml-4">اختر التصميم:</label>
                <select id="design-select" class="p-2 border rounded-md">
                    <option value="design-default">افتراضي (أبيض)</option>
                    <option value="design-wave">خلفية متموجة (أخضر)</option>
                    <option value="design-formal">تدرج رمادي (رسمي)</option>
                    <option value="design-gradient">تدرج ناعم (أخضر)</option>
                </select>
                </div>
            
             <div id="reports-list" class="space-y-1">
                <p class="text-gray-500 text-center p-4">جاري تحميل التقارير...</p>
            </div>
        </div>
    </div>
    
    <div id="report-display-wrapper">
         <div id="report-display" class="hidden">
           </div>
    </div>
    
    <div id="report-actions" class="hidden max-w-4xl mx-auto p-4 text-center no-print bg-white flex justify-center items-center gap-4" style="margin-top: -2rem; position: relative; z-index: 10; border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);">
        <button onclick="downloadPdf()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">تحميل PDF</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
          apiKey: "AIzaSyBMDIL5dPISS4pRimDfN_22NMd1l0QNsCA",
          authDomain: "reports-e0260.firebaseapp.com",
          projectId: "reports-e0260",
          storageBucket: "reports-e0260.firebasestorage.app",
          messagingSenderId: "879236632191",
          appId: "1:879236632191:web:da49b42e6af93ea1d6794a"
        };

        const appId = firebaseConfig.projectId;
        
        let app, db, auth;
        let currentReportData = null;
        let allReportsData = [];
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                listenForReports();
            } else {
                 signInAnonymously(auth).catch(err => {
                     console.error("Anonymous sign-in failed:", err);
                 });
            }
        });

        document.getElementById('logo-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('logo-preview');
            const placeholder = document.getElementById('logo-placeholder');
            if (file && preview && placeholder) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('vision-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('vision-preview');
            const placeholder = document.getElementById('vision-placeholder');
            if (file && preview && placeholder) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('font-select').addEventListener('change', (event) => {
            const reportContent = document.querySelector("#report-display .printable-content");
            if (reportContent) {
                reportContent.style.fontFamily = event.target.value;
            }
        });

        document.getElementById('font-size-select').addEventListener('change', (event) => {
            const reportContent = document.querySelector("#report-display .printable-content");
            if (reportContent) {
                const newSize = event.target.value;
                reportContent.querySelectorAll('.form-label-cell, .form-data-cell').forEach(cell => {
                    cell.style.fontSize = newSize;
                });
                reportContent.querySelectorAll('.footer-name').forEach(name => {
                    name.style.fontSize = `calc(${newSize} + 4px)`;
                });
                reportContent.querySelectorAll('.footer-title').forEach(title => {
                    title.style.fontSize = `calc(${newSize} - 2px)`;
                });
            }
        });

        // === (بداية كود مستمع التصميم) ===
        document.getElementById('design-select').addEventListener('change', (event) => {
            const reportContent = document.querySelector("#report-display .printable-content");
            if (reportContent) {
                // إزالة جميع كلاسات التصميم أولاً
                reportContent.classList.remove('design-wave', 'design-formal', 'design-gradient');
                
                // إضافة الكلاس المختار (إذا لم يكن الافتراضي)
                if (event.target.value !== 'design-default') {
                    reportContent.classList.add(event.target.value);
                }
            }
        });
        // === (نهاية كود مستمع التصميم) ===


        const reportsList = document.getElementById('reports-list');
        const reportDisplay = document.getElementById('report-display');
        const reportActions = document.getElementById('report-actions');
        
        function listenForReports() {
            const reportsRef = collection(db, `/artifacts/${appId}/public/data/strategies`);
            const q = query(reportsRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (querySnapshot) => {
                allReportsData = []; 
                if (querySnapshot.empty) {
                    reportsList.innerHTML = '<p class="text-gray-500 text-center p-4">لا توجد تقارير استراتيجيات محفوظة حتى الآن.</p>';
                    return;
                }

                reportsList.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 font-bold text-sm text-gray-600 px-3 py-2 border-b">
                        <div class="col-span-3">اسم المعلم</div>
                        <div class="col-span-3">الاستراتيجية</div>
                        <div class="col-span-2">المادة</div>
                        <div class="col-span-2">تاريخ التنفيذ</div>
                        <div class="col-span-2 text-center">إجراءات</div>
                    </div>
                `; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allReportsData.push(data); 
                    const docId = doc.id;
                    
                    const teacherName = data.teacherName || 'معلم غير مسجل';
                    const strategyName = data.strategyName || 'استراتيجية غير مسجلة';
                    const subject = data.subject || 'N/A';
                    const executionDate = data.executionDate || 'N/A';

                    const listItem = document.createElement('div');
                    listItem.className = 'grid grid-cols-12 gap-2 items-center text-sm p-3 border-b hover:bg-gray-100 cursor-pointer';
                    
                    listItem.innerHTML = `
                        <div class="col-span-3 font-semibold text-blue-700 truncate" onclick="window.displayReportById('${docId}')">${teacherName}</div>
                        <div class="col-span-3 text-gray-700 truncate" onclick="window.displayReportById('${docId}')">${strategyName}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${subject}</div>
                        <div class="col-span-2 text-gray-500" onclick="window.displayReportById('${docId}')">${executionDate}</div>
                        <div class="col-span-2 text-center flex justify-center gap-3">
                             <a href="./index.html?edit=${docId}" target="_blank" class="text-blue-600 hover:text-blue-800" title="تعديل التقرير">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </a>
                            <button onclick="window.deleteReport(event, '${docId}')" class="text-red-600 hover:text-red-800" title="حذف التقرير">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `;
                    reportsList.appendChild(listItem);
                });

            }, (error) => {
                console.error("Error fetching reports in real-time:", error);
                reportsList.innerHTML = '<p class="text-red-500 text-center p-4">حدث خطأ في تحميل قائمة التقارير.</p>';
            });
        }
        
        window.deleteReport = async function(event, docId) {
            event.stopPropagation(); 

            if (!confirm("هل أنت متأكد من حذف هذا التقرير نهائياً؟")) {
                return;
            }

            try {
                const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
                await deleteDoc(reportRef);
                
                if (currentReportData && currentReportData.id === docId) {
                    reportDisplay.innerHTML = '';
                    reportDisplay.classList.add('hidden');
                    reportActions.classList.add('hidden');
                    currentReportData = null;
                }
                
            } catch (error) {
                console.error("Error deleting report: ", error);
                alert("حدث خطأ أثناء حذف التقرير.");
            }
        }
        
        window.downloadPdf = async function() {
            const reportContent = document.querySelector("#report-display .printable-content");
            const reportContainer = document.getElementById('report-display');
            if (!reportContent || !currentReportData) {
                alert("يرجى عرض تقرير أولاً.");
                return;
            }

            const logoPreview = document.getElementById('logo-preview');
            const visionPreview = document.getElementById('vision-preview');
            
            if (!logoPreview || !visionPreview || logoPreview.src === "" || logoPreview.src.endsWith("/") || visionPreview.src === "" || visionPreview.src.endsWith("/")) {
                alert("يرجى إضافة شعار الوزارة وشعار الرؤية (PNG شفاف) أولاً.");
                return;
            }

            const programName = currentReportData.strategyName || 'استراتيجية';
            const teacherName = currentReportData.teacherName || 'معلم';
            const filename = `${programName} - ${teacherName}.pdf`;

            reportContainer.classList.remove('page-container');
            reportContainer.classList.add('pdf-render-mode');
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const canvas = await html2canvas(reportContent, { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;
                const ratio = pdfWidth / imgWidth;
                const calculatedHeight = imgHeight * ratio;
                let pageHeight = pdfHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, calculatedHeight);
                let heightLeft = calculatedHeight - pageHeight;

                while (heightLeft > 0) {
                    position = position - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, calculatedHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(filename);
            } catch (error) {
                console.error("خطأ في إنشاء PDF:", error);
                alert("حدث خطأ أثناء إنشاء ملف PDF.");
            } finally {
                reportContainer.classList.add('page-container');
                reportContainer.classList.remove('pdf-render-mode');
            }
        }

        window.displayReportById = async (docId) => {
            const reportRef = doc(db, `/artifacts/${appId}/public/data/strategies`, docId);
            try {
                const docSnap = await getDoc(reportRef);
                if (docSnap.exists()){
                    const data = docSnap.data();
                    data.id = docId; 
                    currentReportData = data;
                    displayReportData(data);
                } else {
                    alert("لم يتم العثور على التقرير.");
                    currentReportData = null;
                }
            } catch(error) {
                 alert("خطأ في جلب بيانات التقرير.");
                 console.error(error);
                 currentReportData = null;
            }
        };

        function displayReportData(data) {
            
            let aidsItems = data.teachingAids && data.teachingAids.length > 0
                ? data.teachingAids.map(aid => {
                    if (aid === "أخرى" && (!data.teachingAidsOther || data.teachingAidsOther.trim() === "")) {
                        return null; 
                    }
                    if (aid === "أخرى" && data.teachingAidsOther && data.teachingAidsOther.trim() !== "") {
                        return `<li class="list-disc mr-4">أخرى: ${data.teachingAidsOther}</li>`;
                    }
                    return `<li class="list-disc mr-4">${aid}</li>`;
                }).filter(item => item !== null)
                : [];
            
            if (data.teachingAidsOther && data.teachingAidsOther.trim() !== "" && !data.teachingAids.includes("أخرى")) {
                 aidsItems.push(`<li class="list-disc mr-4">أخرى: ${data.teachingAidsOther}</li>`);
            }

            const aidsList = aidsItems.length > 0
                ? `<ul class="text-blue-800 font-semibold grid grid-cols-2 gap-1 w-full">${aidsItems.join('')}</ul>`
                : '<span class="text-blue-800 font-semibold">لا يوجد</span>';

            const objectivesList = data.objectives
                ? `<div class="text-blue-800 font-semibold">${data.objectives.split('\n').filter(line => line.trim() !== '').map(obj => `<p class="mb-1">${obj}</p>`).join('')}</div>`
                : '<span class="text-blue-800 font-semibold">لا يوجد</span>';
            
            // === (بداية التعديل لتطبيق التصميم المختار) ===
            const selectedFont = document.getElementById('font-select').value;
            const selectedSize = document.getElementById('font-size-select').value;
            const selectedDesign = document.getElementById('design-select').value; // اقرأ التصميم المختار
            const designClass = selectedDesign !== 'design-default' ? selectedDesign : ''; // جهز الكلاس
            
            reportDisplay.innerHTML = `
                <div class="printable-content page-container ${designClass}" style="font-family: ${selectedFont};">
            <header class="bg-[#006b5a] text-white p-4 print-bg-green">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            
                            <div class="w-1/3 text-right">
                                <img id="logo-preview" src="" alt="شعار الوزارة" class="h-20 w-32 mx-auto hidden object-contain">
                                <div id="logo-placeholder" class="h-20 w-32 border-2 border-dashed border-gray-400 flex items-center justify-center text-xs text-gray-400 mx-auto">مكان شعار الوزارة</div>
                            </div>
                            
                            <div class="w-1/3 text-center text-sm leading-tight">
                                <p class="font-bold text-base">المملكة العربية السعودية</p>
                                <p class="font-bold text-base">وزارة التعليم</p>
                                <p class="font-bold text-lg text-yellow-300">الإدارة العامة للتعليم بمنطقة عسير</p>
                                <p class="text-sm">ابتدائية ومتوسطة الراشدون بالمربع</p>
                            </div>

                            <div class="w-1/3 text-left">
                                <img id="vision-preview" src="" alt="شعار الرؤية" class="h-20 w-32 mx-auto hidden object-contain">
                                <div id="vision-placeholder" class="h-20 w-32 border-2 border-dashed border-gray-400 flex items-center justify-center text-xs text-gray-400 mx-auto">مكان شعار الرؤية</div>
                            </div>

                        </div>
                    </header>
                    
                    <h1 class="form-title mt-4 mb-4 mx-4">تقرير تنفيذ استراتجية تدريس</h1>
                    
                    <main class="px-8 py-4">
                        <div class="form-grid">
                            
                            <div class="form-label-cell" style="font-size: ${selectedSize};">الاستراتيجية:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-red-800 font-semibold">${data.strategyName || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">المادة:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.subject || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">تاريخ التنفيذ:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.executionDate || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">الدرس:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.lesson || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">المرحلة الدراسية:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.stage || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">الفصل:</div>
                            <div class="form-data-cell" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.classSection || ''}</span></div>
                            <div class="form-label-cell" style="font-size: ${selectedSize};">عدد الطلاب:</div>
                            <div class="form-data-cell data-span-3" style="font-size: ${selectedSize};"><span class="text-blue-800 font-semibold">${data.studentCount || ''}</span></div>
                            <div class="form-label-cell label-span-1" style="font-size: ${selectedSize};">الأدوات والوسائل التعليمية:</div>
                            <div class="form-data-cell data-span-3" style="font-size: ${selectedSize};">${aidsList}</div>
                            <div class="form-label-cell label-span-1" style="font-size: ${selectedSize};">الأهداف:</div>
                            <div class="form-data-cell data-span-3" style="font-size: ${selectedSize};">${objectivesList}</div>

                            <div class="form-label-cell label-span-1" style="font-size: ${selectedSize};">شواهد التنفيذ:</div>
                            <div class="form-data-cell data-span-3">
                                <div class="w-full flex gap-4">
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image1 ? `<img src="${data.image1}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">لم يتم رفع صورة 1</span>'}
                                        </div>
                                    </div>
                                    <div class="w-1/2">
                                        <div class="evidence-image-container">
                                            ${data.image2 ? `<img src="${data.image2}" class="evidence-image" crossorigin="anonymous">` : '<span class="text-gray-500">لم يتم رفع صورة 2</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer class="flex justify-between items-start pt-10 mt-10 border-t px-10 pb-10">
                        <div class="text-center">
                            <p class="footer-title text-gray-600 text-center" style="font-size: calc(${selectedSize} - 2px);">المعلم المنفذ</p>
                            <p class="footer-name font-bold text-center" style="font-size: calc(${selectedSize} + 4px);">${data.teacherName || 'اسم المعلم'}</p>
                        </div>
                        <div class="text-center">
                             <p class="footer-title text-gray-600 text-center" style="font-size: calc(${selectedSize} - 2px);">مدير المدرسة</p>
                             <p class="footer-name font-bold text-center" style="font-size: calc(${selectedSize} + 4px);">${data.principalName || 'اسم المدير'}</p>
                        </div>
                    </footer>
                    
                    <footer class="bg-[#006b5a] p-4 print-bg-green">
                        <div class="text-center">
                            <p class="text-white text-sm font-bold">www.moe.gov.sa</p>
                        </div>
                    </footer>
                </div>
            `;
            
            const logoPreview = document.getElementById('logo-preview');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            const visionPreview = document.getElementById('vision-preview');
            const visionPlaceholder = document.getElementById('vision-placeholder');
            
            // نعيد تحميل الصور من جديد عند عرض التقرير
            const originalLogoSrc = document.getElementById('logo-upload').files.length > 0 ? URL.createObjectURL(document.getElementById('logo-upload').files[0]) : "";
            const originalVisionSrc = document.getElementById('vision-upload').files.length > 0 ? URL.createObjectURL(document.getElementById('vision-upload').files[0]) : "";

            if (originalLogoSrc) {
                if (logoPreview) logoPreview.src = originalLogoSrc;
                if (logoPreview) logoPreview.classList.remove('hidden');
                if (logoPlaceholder) logoPlaceholder.classList.add('hidden');
            } else {
                if (logoPreview) logoPreview.src = "";
                if (logoPreview) logoPreview.classList.add('hidden');
                if (logoPlaceholder) logoPlaceholder.classList.remove('hidden');
            }

            if (originalVisionSrc) {
                if (visionPreview) visionPreview.src = originalVisionSrc;
                if (visionPreview) visionPreview.classList.remove('hidden');
                if (visionPlaceholder) visionPlaceholder.classList.add('hidden');
            } else {
                if (visionPreview) visionPreview.src = "";
                if (visionPreview) visionPreview.classList.add('hidden');
                if (visionPlaceholder) visionPlaceholder.classList.remove('hidden');
            }
            
            reportDisplay.classList.add('page-container');
            reportDisplay.classList.remove('hidden');
            reportActions.classList.remove('hidden');
            reportDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
